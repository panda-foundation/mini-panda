namespace test;

public var cpu3 Cpu = {123, {456}};

public enum Level
{
    low,
    high
}

public enum Timer
{
    timer1 = 1,
    timer2,
    timer3,
    timer4
}

public struct Pwm
{
    public var freq u32;
}

public struct Cpu
{
    public var osc u32;
    public var pwm Pwm;

    public function set_pwm(freq u32) u32
    {
        this.pwm.freq = freq;
        return this.pwm.freq;
    }

    public function get_osc() u32 {
        return this.osc;
    }
}

public struct Gpu
{
    public var pwm pointer<Pwm>;
}

public function test_declaration() 
{
    console.write_string("============ test declaration ============\n");

    // function
    var addOne add_one = increment;
    var value i32 = 99;
    value = addOne(value);
    assert(value == 100, "use function pointer to calculate 99 + 1, should equal 100");
    value = another_add_one(value);
    assert(value == 101, "use function pointer to calculate 100 + 1, should equal 101");
    value = do_something(increment, value);
    assert(value == 102, "use function wrapper to calculate 101 + 1, should equal 102");

    // struct
    assert(cpu3.get_osc() == 123, "cpu3.get_osc() should equal 123");
    var cpu4 pointer<Cpu> = &cpu3;
    cpu4.osc = 333;
    assert(cpu4.get_osc() == 333, "cpu4.get_osc() should equal 333");
    call_cpu(cpu4);
    assert(cpu3.get_osc() == 555, "cpu3.get_osc() should equal 555");
}

public function do_something(func add_one, value i32) i32 
{
    return func(value);
}

public function increment(value i32) i32 
{
    return value + 1;
}

public function add_one(value i32) i32;

public var another_add_one add_one = increment;

public function call_cpu(cpu pointer<Cpu>)
{
    cpu.osc = 555;
}